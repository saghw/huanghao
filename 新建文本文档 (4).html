<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°å¹´å¿«ä¹ - éš”ç©ºæ‰‹åŠ¿äº¤äº’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e, #ffd93d);
            overflow: hidden;
            position: relative;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .title {
            text-align: center;
            color: #fff;
            padding: 20px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            position: relative;
        }

        .title h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .title p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* æ‘„åƒå¤´å®¹å™¨ */
        .camera-container {
            width: 90%;
            height: 60vh;
            margin: 0 auto;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 5;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œç¬¦åˆè‡ªæ‹ä¹ æƒ¯ */
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* å’Œè§†é¢‘åŒæ­¥é•œåƒ */
        }

        /* ç‰¹æ•ˆå…ƒç´  */
        .effect {
            position: absolute;
            color: #fff;
            font-size: 1.5rem;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
            z-index: 8;
            opacity: 0;
            transition: all 0.5s ease;
        }

        /* çƒŸèŠ±åŠ¨ç”» */
        @keyframes firework {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }

        .firework {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff, #ffd93d, #ff6b6b);
            box-shadow: 0 0 20px #fff;
            opacity: 0;
            animation: firework 1s ease-out forwards;
        }

        /* é€‚é…å°å±æ‰‹æœº */
        @media (max-width: 375px) {
            .title h1 {
                font-size: 1.8rem;
            }
            .camera-container {
                height: 55vh;
            }
        }
    </style>
</head>
<body>
    <div class="title">
        <h1>æ–°å¹´å¿«ä¹ ğŸ§§</h1>
        <p>éš”ç©ºæ¯”å¿ƒ/OK/æ•°å­—8 è§¦å‘ç‰¹æ•ˆ</p>
    </div>
    <div class="camera-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <!-- å¼•å…¥TensorFlow.jså’ŒHandPoseæ¨¡å‹ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@2.0.0/dist/hand-pose-detection.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let video, canvas, ctx;
        let detector; // æ‰‹éƒ¨æ£€æµ‹å™¨
        let lastGestureTime = 0; // æœ€åä¸€æ¬¡è§¦å‘æ‰‹åŠ¿çš„æ—¶é—´ï¼ˆé˜²é‡å¤ï¼‰
        const GESTURE_COOLDOWN = 1500; // æ‰‹åŠ¿å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

        // åˆå§‹åŒ–å‡½æ•°
        async function init() {
            // è·å–DOMå…ƒç´ 
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            // é€‚é…canvaså°ºå¯¸
            function resizeCanvas() {
                canvas.width = video.offsetWidth;
                canvas.height = video.offsetHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // åˆå§‹åŒ–æ‘„åƒå¤´
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user', // å‰ç½®æ‘„åƒå¤´
                        width: { ideal: window.innerWidth },
                        height: { ideal: window.innerHeight }
                    },
                    audio: false
                });
                video.srcObject = stream;
                video.play();
            } catch (err) {
                alert('è¯·å…è®¸è®¿é—®æ‘„åƒå¤´ä»¥ä½¿ç”¨éš”ç©ºæ‰‹åŠ¿åŠŸèƒ½ï¼\né”™è¯¯ï¼š' + err.message);
                console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥ï¼š', err);
                return;
            }

            // åŠ è½½æ‰‹éƒ¨æ£€æµ‹æ¨¡å‹
            try {
                const model = handPoseDetection.SupportedModels.MediaPipeHands;
                const detectorConfig = {
                    runtime: 'tfjs',
                    modelType: 'lite', // è½»é‡ç‰ˆï¼Œé€‚é…ç§»åŠ¨ç«¯
                    maxHands: 1 // åªæ£€æµ‹ä¸€åªæ‰‹
                };
                detector = await handPoseDetection.createDetector(model, detectorConfig);
                console.log('æ‰‹éƒ¨æ¨¡å‹åŠ è½½æˆåŠŸï¼');
                
                // å¼€å§‹æ£€æµ‹
                detectHands();
            } catch (err) {
                alert('æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼');
                console.error('æ¨¡å‹åŠ è½½å¤±è´¥ï¼š', err);
            }
        }

        // æ‰‹éƒ¨æ£€æµ‹ä¸»å‡½æ•°
        async function detectHands() {
            if (!detector || video.paused) {
                requestAnimationFrame(detectHands);
                return;
            }

            // æ£€æµ‹æ‰‹éƒ¨å…³é”®ç‚¹
            const hands = await detector.estimateHands(video, {
                flipHorizontal: true // é•œåƒç¿»è½¬ï¼Œå’Œè§†é¢‘åŒæ­¥
            });

            // æ¸…ç©ºcanvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // å¦‚æœæ£€æµ‹åˆ°æ‰‹éƒ¨
            if (hands.length > 0) {
                const hand = hands[0];
                const keypoints = hand.keypoints;

                // ç»˜åˆ¶æ‰‹éƒ¨å…³é”®ç‚¹å’Œè¿çº¿ï¼ˆå¯è§†åŒ–ï¼‰
                drawHand(keypoints);

                // åˆ¤æ–­æ‰‹åŠ¿
                const gesture = recognizeGesture(keypoints);
                if (gesture && Date.now() - lastGestureTime > GESTURE_COOLDOWN) {
                    triggerEffect(gesture, keypoints[8]); // 8å·å…³é”®ç‚¹æ˜¯é£ŸæŒ‡æŒ‡å°–
                    lastGestureTime = Date.now();
                }
            }

            // å¾ªç¯æ£€æµ‹
            requestAnimationFrame(detectHands);
        }

        // ç»˜åˆ¶æ‰‹éƒ¨å…³é”®ç‚¹å’Œè¿çº¿
        function drawHand(keypoints) {
            // å…³é”®ç‚¹è¿æ¥é¡ºåºï¼ˆæ‰‹éƒ¨éª¨éª¼ï¼‰
            const connections = [
                [0,1], [1,2], [2,3], [3,4], // æ‹‡æŒ‡
                [0,5], [5,6], [6,7], [7,8], // é£ŸæŒ‡
                [0,9], [9,10], [10,11], [11,12], // ä¸­æŒ‡
                [0,13], [13,14], [14,15], [15,16], // æ— åæŒ‡
                [0,17], [17,18], [18,19], [19,20] // å°æŒ‡
            ];

            // ç»˜åˆ¶è¿çº¿
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            connections.forEach(([start, end]) => {
                ctx.beginPath();
                ctx.moveTo(keypoints[start].x, keypoints[start].y);
                ctx.lineTo(keypoints[end].x, keypoints[end].y);
                ctx.stroke();
            });

            // ç»˜åˆ¶å…³é”®ç‚¹
            ctx.fillStyle = '#ff0000';
            keypoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // æ‰‹åŠ¿è¯†åˆ«é€»è¾‘
        function recognizeGesture(keypoints) {
            // è·å–å…³é”®ç‚¹ä½åæ ‡
            const thumbTip = keypoints[4]; // æ‹‡æŒ‡å°–
            const indexTip = keypoints[8]; // é£ŸæŒ‡å°–
            const middleTip = keypoints[12]; // ä¸­æŒ‡å°–
            const ringTip = keypoints[16]; // æ— åæŒ‡å°–
            const pinkyTip = keypoints[20]; // å°æŒ‡å°–

            // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´è·ç¦»
            const getDistance = (p1, p2) => {
                return Math.hypot(p1.x - p2.x, p1.y - p2.y);
            };

            // 1. æ¯”å¿ƒæ‰‹åŠ¿ï¼ˆæ‹‡æŒ‡å’Œé£ŸæŒ‡æŒ‡å°–é è¿‘ï¼Œå…¶ä»–æ‰‹æŒ‡å¼¯æ›²ï¼‰
            const thumbIndexDist = getDistance(thumbTip, indexTip);
            const isHeart = thumbIndexDist < 30 && 
                            keypoints[12].y > keypoints[9].y && // ä¸­æŒ‡å¼¯æ›²
                            keypoints[16].y > keypoints[13].y && // æ— åæŒ‡å¼¯æ›²
                            keypoints[20].y > keypoints[17].y; // å°æŒ‡å¼¯æ›²

            // 2. OKæ‰‹åŠ¿ï¼ˆæ‹‡æŒ‡å’Œé£ŸæŒ‡å›´æˆåœˆï¼Œå…¶ä»–æ‰‹æŒ‡ä¼¸ç›´ï¼‰
            const isOK = thumbIndexDist < 40 && 
                         keypoints[8].y < keypoints[6].y && // é£ŸæŒ‡ä¼¸ç›´
                         keypoints[12].y < keypoints[10].y && // ä¸­æŒ‡ä¼¸ç›´
                         keypoints[16].y < keypoints[14].y; // æ— åæŒ‡ä¼¸ç›´

            // 3. æ•°å­—8æ‰‹åŠ¿ï¼ˆé£ŸæŒ‡å’Œä¸­æŒ‡ä¼¸ç›´åˆ†å¼€ï¼Œå…¶ä»–æ‰‹æŒ‡å¼¯æ›²ï¼‰
            const indexMiddleDist = getDistance(indexTip, middleTip);
            const isEight = indexMiddleDist > 40 && 
                            keypoints[8].y < keypoints[6].y && // é£ŸæŒ‡ä¼¸ç›´
                            keypoints[12].y < keypoints[10].y && // ä¸­æŒ‡ä¼¸ç›´
                            keypoints[4].y > keypoints[2].y && // æ‹‡æŒ‡å¼¯æ›²
                            keypoints[16].y > keypoints[14].y; // æ— åæŒ‡å¼¯æ›²

            // è¿”å›è¯†åˆ«åˆ°çš„æ‰‹åŠ¿
            if (isHeart) return 'heart';
            if (isOK) return 'ok';
            if (isEight) return 'eight';
            return null;
        }

        // è§¦å‘æ–°å¹´ç‰¹æ•ˆ
        function triggerEffect(gesture, position) {
            // è½¬æ¢åæ ‡ï¼ˆå› ä¸ºcanvasé•œåƒäº†ï¼Œéœ€è¦è¿˜åŸåˆ°é¡µé¢åæ ‡ï¼‰
            const rect = canvas.getBoundingClientRect();
            const x = rect.left + (canvas.width - position.x);
            const y = rect.top + position.y;

            // æ ¹æ®ä¸åŒæ‰‹åŠ¿è§¦å‘ä¸åŒç‰¹æ•ˆ
            switch(gesture) {
                case 'heart':
                    createTextEffect('æ™¶æ™¶å®è´æ–°å¹´å¿«ä¹ â¤ï¸', x, y);
                    createFirework(x, y);
                    break;
                case 'ok':
                    createTextEffect('ä¸‡äº‹å¤§å‰ âœ¨', x, y);
                    createFirework(x, y);
                    createFirework(x + 50, y - 30);
                    break;
                case 'eight':
                    createTextEffect('æ­å–œå‘è´¢ ğŸ§§', x, y);
                    createFirework(x, y);
                    createFirework(x - 50, y + 30);
                    createFirework(x + 50, y - 50);
                    break;
            }
        }

        // åˆ›å»ºæ–‡å­—ç‰¹æ•ˆ
        function createTextEffect(text, x, y) {
            const effect = document.createElement('div');
            effect.className = 'effect';
            effect.textContent = text;
            effect.style.left = `${x}px`;
            effect.style.top = `${y}px`;
            document.body.appendChild(effect);

            // åŠ¨ç”»æ•ˆæœ
            setTimeout(() => {
                effect.style.opacity = '1';
                effect.style.transform = 'translateY(-20px)';
            }, 10);

            // ç§»é™¤å…ƒç´ 
            setTimeout(() => {
                effect.style.opacity = '0';
                effect.style.transform = 'translateY(-40px)';
                setTimeout(() => {
                    document.body.removeChild(effect);
                }, 500);
            }, 1500);
        }

        // åˆ›å»ºçƒŸèŠ±ç‰¹æ•ˆ
        function createFirework(x, y) {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = `${x}px`;
            firework.style.top = `${y}px`;
            firework.style.animationDelay = `${Math.random() * 0.3}s`;
            document.body.appendChild(firework);

            // ç§»é™¤çƒŸèŠ±å…ƒç´ 
            setTimeout(() => {
                document.body.removeChild(firework);
            }, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>